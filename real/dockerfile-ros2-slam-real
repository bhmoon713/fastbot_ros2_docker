FROM osrf/ros:humble-desktop-full
SHELL ["/bin/bash","-lc"]

# System & ROS 2 deps
RUN apt-get update && apt-get install -y \
    python3-colcon-common-extensions \
    ros-humble-rviz2 \
    ros-humble-nav2-msgs \
    ros-humble-nav2-amcl \
    ros-humble-nav2-map-server \
    ros-humble-nav2-planner \
    ros-humble-nav2-bringup \
    ros-humble-nav2-bt-navigator \
    ros-humble-cartographer-ros \
    ros-humble-rmw-cyclonedds-cpp \
    ros-humble-tf2-ros \
    && rm -rf /var/lib/apt/lists/*

# Workspace
WORKDIR /ros2_ws
COPY fastbot/ src/fastbot/

# Build once at image build time
RUN source /opt/ros/humble/setup.bash && colcon build --symlink-install

# Defaults for distributed ROS 2 (tweak at run time if needed)
ENV RMW_IMPLEMENTATION=rmw_cyclonedds_cpp \
    ROS_DOMAIN_ID=42 \
    ROS_LOCALHOST_ONLY=0

# Source + launch SLAM (change to localization.launch.py if not mapping)
ENTRYPOINT ["/bin/bash","-lc"]
CMD ["source /opt/ros/humble/setup.bash && source /ros2_ws/install/setup.bash && ros2 launch fastbot_slam cartographer.launch.py"]
